# Victor Hugo CMS - Code Review Findings
# Generated: 2025-12-22
# Expert Panel Review Results

metadata:
  project: Victor Hugo CMS
  codebase_size: ~2500 lines
  file_count: 15 Swift files
  review_date: 2025-12-22
  experts:
    - SwiftUI Architecture Expert
    - Performance and Concurrency Expert
    - Code Quality and Maintainability Expert
    - AppKit Integration Expert

# Issues are organized by severity and confidence
# Severity: critical, high, medium, low
# Confidence: 0-100 (how sure we are this is an issue)
# Effort: small (< 1hr), medium (1-3hr), large (3-8hr), xlarge (8hr+)

critical_issues:
  - id: CRIT-001
    title: Race Condition in AutoSaveService - Double Continuation Resume
    expert: Performance and Concurrency
    confidence: 95
    severity: critical
    effort: small
    location:
      file: Victor/Services/AutoSaveService.swift
      lines: 100-122
    description: |
      The performSave method can crash with "continuation already resumed" error.
      NSFileCoordinator error handling (lines 119-121) can execute after the
      coordination block already resumed (lines 114-116), causing double-resume.
    impact: |
      App will crash deterministically when file coordination fails.
      This is a production-blocking bug.
    recommendation: |
      Add a captured flag to track whether continuation has been resumed:

      var didResume = false
      coordinator.coordinate(writingItemAt: fileURL, options: .forReplacing, error: &coordinatorError) { url in
          do {
              try content.write(to: url, atomically: true, encoding: .utf8)
              let attributes = try FileManager.default.attributesOfItem(atPath: url.path)
              let newModificationDate = attributes[.modificationDate] as? Date ?? Date()
              continuation.resume(returning: newModificationDate)
              didResume = true
          } catch {
              continuation.resume(throwing: error)
              didResume = true
          }
      }

      if !didResume, let error = coordinatorError {
          continuation.resume(throwing: error)
      }

  - id: CRIT-002
    title: Memory Leak in Recursive Search Filter
    expert: Performance and Concurrency
    confidence: 100
    severity: critical
    effort: large
    location:
      file: Victor/ViewModels/SiteViewModel.swift
      lines: 55-82
    description: |
      filterNodesRecursively creates NEW FileNode instances for every search query.
      Since FileNode is @Observable (reference type), these copies create strong
      references that are never cleaned up. Typing in search causes exponential
      memory growth on large sites (500+ files).
    impact: |
      Memory grows by several MB per keystroke. App becomes unusable after a few searches.
      Will cause OOM crashes on large Hugo sites.
    recommendation: |
      Don't create copies. Filter in-place and use a Set to track expanded nodes:

      1. Add property: private var expandedNodeIDs: Set<UUID> = []
      2. Return original node references, not copies
      3. Mark nodes for expansion in expandedNodeIDs set
      4. Use expandedNodeIDs in view to determine disclosure state

      Alternative: Make FileNode a struct instead of class (requires architecture change)
    refactoring_notes: |
      This is a fundamental issue with mixing @Observable classes and filtering.
      Consider whether FileNode should be a value type (struct) or if we need
      a different filtering approach.

high_priority_issues:
  - id: HIGH-001
    title: Synchronous File I/O on Main Thread (isPageBundle)
    expert: Performance and Concurrency
    confidence: 90
    severity: high
    effort: medium
    location:
      file: Victor/Models/FileNode.swift
      lines: 27-33
    description: |
      isPageBundle computed property calls FileManager.default.fileExists()
      synchronously. This is called from SwiftUI view bodies on main thread,
      causing UI freezes for slow filesystems (network drives, encrypted volumes).
    impact: |
      UI freezes when rendering large file lists with many directories.
      Bad user experience on slower filesystems.
    recommendation: |
      Cache isPageBundle during tree construction:

      1. Change to stored property: let isPageBundle: Bool
      2. Compute once in FileSystemService.buildFileTree():

         if isDirectory {
             let indexMD = itemURL.appendingPathComponent("index.md")
             let underscoreIndexMD = itemURL.appendingPathComponent("_index.md")
             let isBundle = fileManager.fileExists(atPath: indexMD.path) ||
                           fileManager.fileExists(atPath: underscoreIndexMD.path)
             let dirNode = FileNode(url: itemURL, isDirectory: true, isPageBundle: isBundle)
         }

  - id: HIGH-002
    title: Blocking Disk I/O on Main Thread (FileSystemService)
    expert: Performance and Concurrency
    confidence: 90
    severity: high
    effort: large
    location:
      file: Victor/Services/FileSystemService.swift
      lines: 6, 87-148
    description: |
      FileSystemService is marked @MainActor, so ALL methods run on main thread.
      Scanning 500+ files with recursive directory traversal blocks UI for seconds.
    impact: |
      UI freezes for 2-5 seconds when opening large Hugo sites.
      Terrible first-impression UX.
    recommendation: |
      1. Remove @MainActor from class declaration
      2. Only mark UI-specific methods @MainActor (like selectHugoSiteFolder)
      3. Move scanDirectory and buildFileTree to background:

         func scanDirectory(at url: URL) async throws -> [FileNode] {
             try await Task.detached {
                 // Existing logic here
             }.value
         }

  - id: HIGH-003
    title: Blocking CPU Work on Main Thread (FrontmatterParser)
    expert: Performance and Concurrency
    confidence: 88
    severity: high
    effort: small
    location:
      file: Victor/Services/FrontmatterParser.swift
      lines: 6-8
    description: |
      FrontmatterParser is marked @MainActor but performs CPU-intensive YAML/TOML/JSON
      parsing. Called synchronously from FileSystemService.readContentFile() which is
      also on main thread.
    impact: |
      UI stutters when loading files with large frontmatter blocks (100ms+ delays).
    recommendation: |
      Remove @MainActor annotation. Parsing doesn't need main thread:

      class FrontmatterParser {  // No @MainActor
          static let shared = FrontmatterParser()
          // Rest stays the same
      }

  - id: HIGH-004
    title: Missing EditorViewModel - Business Logic in Views
    expert: SwiftUI Architecture
    confidence: 90
    severity: high
    effort: xlarge
    location:
      file: Victor/Views/MainWindow/ContentView.swift
      lines: 70-223
    description: |
      EditorPanelView contains 150+ lines of business logic including:
      - Frontmatter serialization
      - Auto-save coordination
      - Conflict resolution
      - State management

      This violates MVVM architecture. Views should be thin presentation layers.
    impact: |
      - Untestable business logic
      - Difficult to maintain
      - Violates MVVM separation of concerns
    recommendation: |
      Create EditorViewModel:

      @MainActor
      @Observable
      class EditorViewModel {
          private let fileNode: FileNode
          private let contentFile: ContentFile

          var editableContent: String
          var isSaving: Bool = false
          var hasUnsavedChanges: Bool { /* ... */ }

          func save() async -> Bool { /* ... */ }
          func scheduleAutoSave() { /* ... */ }
          func handleConflict() -> ConflictResolution { /* ... */ }
      }

      This would move ~100 lines of logic out of the view.

  - id: HIGH-005
    title: Direct Service Calls from Views
    expert: SwiftUI Architecture
    confidence: 85
    severity: high
    effort: medium
    location:
      file: Victor/Views/MainWindow/ContentView.swift
      lines: 192-221
    description: |
      EditorPanelView directly calls AutoSaveService.shared and
      FrontmatterParser.shared, bypassing the ViewModel layer.
    impact: |
      - Breaks MVVM architecture
      - Makes views untestable
      - Tight coupling between view and service layers
    recommendation: |
      All service calls should flow through ViewModels:
      View → ViewModel → Service

      Move service interactions to EditorViewModel (see HIGH-004)

  - id: HIGH-006
    title: Missing Keyboard Shortcuts (⌘B, ⌘I)
    expert: AppKit Integration
    confidence: 88
    severity: high
    effort: medium
    location:
      file: Victor/Views/MainWindow/ContentView.swift
      lines: 227-326
    description: |
      Formatting buttons (Bold, Italic) exist in toolbar but no global keyboard
      shortcuts. Users expect ⌘B/⌘I to work when editor is focused.
    impact: |
      Missing standard macOS text editing conventions. Power users will be frustrated.
    recommendation: |
      Add keyboard shortcuts in VictorApp.swift:

      CommandGroup(after: .textFormatting) {
          Button("Bold") {
              // Send action to first responder
          }
          .keyboardShortcut("b", modifiers: .command)

          Button("Italic") {
              // Send action to first responder
          }
          .keyboardShortcut("i", modifiers: .command)
      }

      Or implement in NSTextView's keyDown override.

  - id: HIGH-007
    title: Missing Undo/Redo Menu Integration
    expert: AppKit Integration
    confidence: 92
    severity: high
    effort: small
    location:
      file: Victor/VictorApp.swift
      lines: 4-35
    description: |
      NSTextView has built-in undo (allowsUndo = true) but menu items aren't
      exposed in Edit menu. Users may not discover undo/redo functionality.
    impact: |
      Discoverability issue - users may think undo doesn't exist.
      Against macOS HIG.
    recommendation: |
      Add standard Edit menu commands:

      .commands {
          CommandGroup(replacing: .undoRedo) {}  // Uses default undo/redo
      }

medium_priority_issues:
  - id: MED-001
    title: Code Duplication - Frontmatter Parsing Logic
    expert: Code Quality
    confidence: 95
    severity: medium
    effort: small
    location:
      file: Victor/Services/MarkdownRenderer.swift
      lines: 38-101
    description: |
      MarkdownRenderer duplicates frontmatter stripping logic that already
      exists in FrontmatterParser (60+ lines of duplicate code).
    impact: |
      Maintenance burden - changes need to happen in two places.
      Risk of inconsistent behavior.
    recommendation: |
      Use FrontmatterParser instead:

      private func stripFrontmatter(from content: String) -> String {
          let (_, markdown) = FrontmatterParser.shared.parseContent(content)
          return markdown
      }

      Delete stripDelimitedFrontmatter and stripJSONFrontmatter methods.

  - id: MED-002
    title: Code Duplication - openPageBundle Method
    expert: Code Quality
    confidence: 100
    severity: medium
    effort: small
    location:
      file: Victor/Views/MainWindow/SidebarView.swift
      lines: [210-220, 257-267]
    description: |
      Identical openPageBundle method appears in FileListView and FileTreeRow.
    recommendation: |
      Extract to FileNode extension:

      extension FileNode {
          var indexFile: FileNode? {
              guard isPageBundle else { return nil }
              return children.first { child in
                  let name = child.name.lowercased()
                  return name == "index.md" || name == "_index.md"
              }
          }
      }

      Usage: if let indexFile = bundle.indexFile { ... }

  - id: MED-003
    title: Alert Binding Anti-Pattern
    expert: SwiftUI Architecture
    confidence: 85
    severity: medium
    effort: small
    location:
      file: Victor/Views/MainWindow/ContentView.swift
      lines: 52-60
    description: |
      Alert uses .constant() which prevents proper two-way binding.
      Can cause alert to not dismiss properly or re-appear unexpectedly.
    recommendation: |
      Create computed binding:

      .alert("Error", isPresented: Binding(
          get: { siteViewModel.errorMessage != nil },
          set: { if !$0 { siteViewModel.errorMessage = nil } }
      ))

  - id: MED-004
    title: Non-Standard Sidebar Toggle Implementation
    expert: AppKit Integration
    confidence: 95
    severity: medium
    effort: small
    location:
      file: Victor/Views/MainWindow/ContentView.swift
      lines: 63-65
    description: |
      Sidebar toggle uses responder chain hack instead of NavigationSplitView's
      columnVisibility binding. Fragile and could break with window structure changes.
    recommendation: |
      Use columnVisibility directly:

      private func toggleSidebar() {
          columnVisibility = columnVisibility == .all ? .detailOnly : .all
      }

  - id: MED-005
    title: Preview Debounce Task Not Cancelled
    expert: AppKit Integration
    confidence: 90
    severity: medium
    effort: small
    location:
      file: Victor/Views/MainWindow/ContentView.swift
      lines: 330-365
    description: |
      debounceTask isn't cancelled when view disappears. Could execute
      and update state on deallocated view when switching files quickly.
    recommendation: |
      Add cleanup:

      .onDisappear {
          debounceTask?.cancel()
      }

  - id: MED-006
    title: Large Files Need Splitting
    expert: Code Quality
    confidence: 80
    severity: medium
    effort: medium
    location:
      files:
        - Victor/Views/MainWindow/ContentView.swift (545 lines)
        - Victor/Views/MainWindow/SidebarView.swift (354 lines)
    description: |
      ContentView.swift contains 5 separate view structs and enums.
      SidebarView.swift contains 7 view structs.
    recommendation: |
      Split ContentView.swift into:
      - ContentView.swift (main layout only)
      - EditorPanelView.swift
      - FrontmatterBottomPanel.swift
      - PreviewPanel.swift

      Split SidebarView.swift into:
      - SidebarView.swift (main sidebar)
      - FileListView.swift
      - SidebarComponents.swift

  - id: MED-007
    title: Silent Error Handling in FrontmatterParser
    expert: Code Quality
    confidence: 85
    severity: medium
    effort: medium
    location:
      file: Victor/Services/FrontmatterParser.swift
      lines: [171, 208, 223, 338, 419]
    description: |
      Parse/serialization errors are only printed, not surfaced to users.
      Users won't know if frontmatter is corrupted.
    recommendation: |
      Return Result types or throw errors:

      enum FrontmatterError: LocalizedError {
          case yamlParsingFailed(String)
          case tomlParsingFailed(String)
          case jsonParsingFailed(String)
      }

      func parseContent(_ content: String) -> Result<(Frontmatter?, String), FrontmatterError>

  - id: MED-008
    title: Missing Accessibility Labels
    expert: AppKit Integration
    confidence: 83
    severity: medium
    effort: medium
    location:
      file: Victor/Views/MainWindow/SidebarView.swift
      lines: 272-334
    description: |
      FileRowView uses icons and badges but doesn't provide accessibility
      labels for VoiceOver users. Blind users can't distinguish file types.
    recommendation: |
      Add accessibility labels:

      Image(systemName: iconName)
          .accessibilityLabel(accessibilityIconLabel)

      private var accessibilityIconLabel: String {
          if node.isPageBundle { return "Page bundle" }
          else if node.isDirectory { return "Folder" }
          else { return "Markdown file" }
      }

  - id: MED-009
    title: Potential Retain Cycle in EditorPanelView Closures
    expert: Performance and Concurrency
    confidence: 75
    severity: medium
    effort: small
    location:
      file: Victor/Views/MainWindow/ContentView.swift
      lines: 192-221
    description: |
      scheduleAutoSave closures capture self and are stored in singleton
      AutoSaveService. View won't be released until task completes (2+ seconds).
    recommendation: |
      Use [weak self] capture:

      onConflict: { [weak self] @MainActor in
          guard let self = self else { return .cancel }
          showConflictAlert = true
          return .cancel
      }

      And cancel auto-save on view disappear.

  - id: MED-010
    title: O(n²) Performance in File Tree Sorting
    expert: Performance and Concurrency
    confidence: 82
    severity: medium
    effort: small
    location:
      file: Victor/Services/FileSystemService.swift
      lines: 130, 141-146
    description: |
      buildFileTree sorts nodes twice - once per directory via sortChildren(),
      then again at the end. For 500 files across 100 dirs = thousands of sorts.
    recommendation: |
      Remove sortChildren() call on line 130. Only sort once at end of each level.

low_priority_issues:
  - id: LOW-001
    title: Missing Memory Cleanup in EditorTextView.Coordinator
    expert: AppKit Integration
    confidence: 85
    severity: low
    effort: small
    location:
      file: Victor/Views/Editor/EditorTextView.swift
      lines: 103-123
    description: |
      Coordinator doesn't clear NSTextView's delegate in deinit.
    recommendation: |
      Add:
      deinit {
          textView?.delegate = nil
      }

  - id: LOW-002
    title: Deprecated KVC for WKWebView Background
    expert: AppKit Integration
    confidence: 80
    severity: low
    effort: small
    location:
      file: Victor/Views/Preview/PreviewWebView.swift
      lines: 15
    description: |
      Uses deprecated setValue(forKey: "drawsBackground") which may break in future macOS.
    recommendation: |
      Replace with:
      webView.isOpaque = false
      webView.underPageBackgroundColor = .clear

  - id: LOW-003
    title: Magic Numbers Should Be Named Constants
    expert: Code Quality
    confidence: 80
    severity: low
    effort: small
    locations:
      - file: Victor/Services/AutoSaveService.swift
        line: 8
        value: 2.0 seconds
      - file: Victor/Views/MainWindow/ContentView.swift
        line: 349
        value: 300ms
      - file: Victor/Views/Editor/EditorTextView.swift
        line: 33
        value: font size 13
    recommendation: |
      Extract to named constants:

      enum AppConstants {
          enum AutoSave {
              static let debounceInterval: TimeInterval = 2.0
          }
          enum Preview {
              static let debounceInterval: TimeInterval = 0.3
          }
          enum Editor {
              static let fontSize: CGFloat = 13
          }
      }

  - id: LOW-004
    title: Unstructured Task in SiteViewModel.init
    expert: Performance and Concurrency
    confidence: 82
    severity: low
    effort: small
    location:
      file: Victor/ViewModels/SiteViewModel.swift
      lines: 89-91
    description: |
      Task created in init isn't stored. Could try to access deallocated memory
      if SiteViewModel is deallocated during async operation.
    recommendation: |
      Store and cancel in deinit:

      private var initTask: Task<Void, Never>?

      init() {
          initTask = Task { await loadSavedSite() }
      }

      deinit {
          initTask?.cancel()
      }

  - id: LOW-005
    title: Repeated DateFormatter Creation
    expert: Performance and Concurrency
    confidence: 80
    severity: low
    effort: small
    location:
      file: Victor/Services/FrontmatterParser.swift
      lines: 426-432
    description: |
      formatDate() creates new DateFormatter instance on every call (~100µs overhead).
    recommendation: |
      Cache as static:

      private static let hugoDateFormatter: DateFormatter = {
          let formatter = DateFormatter()
          formatter.dateFormat = "yyyy-MM-dd"
          formatter.locale = Locale(identifier: "en_US_POSIX")
          return formatter
      }()

  - id: LOW-006
    title: Missing Escape Key Handler in SearchBar
    expert: AppKit Integration
    confidence: 80
    severity: low
    effort: small
    location:
      file: Victor/Views/MainWindow/SidebarView.swift
      lines: 114-148
    description: |
      Search field doesn't clear on Escape key (standard macOS pattern).
    recommendation: |
      Add:
      TextField("Search files", text: $searchText)
          .onKeyPress(.escape) {
              searchText = ""
              return .handled
          }

  - id: LOW-007
    title: Missing Documentation for Public APIs
    expert: Code Quality
    confidence: 85
    severity: low
    effort: medium
    locations:
      - FileSystemService.scanDirectory(at:)
      - SiteViewModel.selectNode(_:)
      - AutoSaveService.scheduleAutoSave(...)
    recommendation: |
      Add proper documentation comments with parameters, return values, and behavior.

  - id: LOW-008
    title: Inconsistent Access Control
    expert: Code Quality
    confidence: 80
    severity: low
    effort: small
    description: |
      Many properties/methods don't explicitly declare access control.
    recommendation: |
      Explicitly mark access levels (private, fileprivate, internal, public).

refactoring_opportunities:
  - id: REFACTOR-001
    title: Extract Content Assembly to ContentFile Method
    effort: small
    benefit: high
    current_pattern: |
      // Appears twice in ContentView
      let fullContent: String
      if let frontmatter = contentFile.frontmatter {
          let serialized = FrontmatterParser.shared.serializeFrontmatter(frontmatter)
          fullContent = serialized + "\n" + editableContent
      } else {
          fullContent = editableContent
      }
    suggested_pattern: |
      // Add to ContentFile.swift
      func fullContentWith(markdown: String) -> String {
          guard let frontmatter = frontmatter else { return markdown }
          let serialized = FrontmatterParser.shared.serializeFrontmatter(frontmatter)
          return serialized + "\n" + markdown
      }

      // Usage
      let fullContent = contentFile.fullContentWith(markdown: editableContent)

  - id: REFACTOR-002
    title: Consolidate Node Sorting Logic
    effort: small
    benefit: medium
    suggested_pattern: |
      // Add to FileNode.swift
      extension FileNode {
          static func defaultSort(_ lhs: FileNode, _ rhs: FileNode) -> Bool {
              if lhs.isDirectory != rhs.isDirectory {
                  return lhs.isDirectory
              }
              return lhs.name.localizedCaseInsensitiveCompare(rhs.name) == .orderedAscending
          }
      }

      // Usage throughout codebase
      children.sort(by: FileNode.defaultSort)
      nodes.sort(by: FileNode.defaultSort)

  - id: REFACTOR-003
    title: Extract Hardcoded CSS to Resource File
    effort: medium
    benefit: low
    location:
      file: Victor/Services/MarkdownRenderer.swift
      lines: 176-362
    description: |
      186 lines of CSS embedded as string literal. Should be external resource.
    recommendation: |
      Move to Victor/Resources/preview-styles.css and load dynamically,
      or use Down library's built-in styling.

  - id: REFACTOR-004
    title: Add Protocol Abstractions for Testability
    effort: large
    benefit: high
    description: |
      Services use singleton pattern which makes testing difficult.
    recommendation: |
      Create protocols:
      - FileSystemServicing
      - FrontmatterParsing
      - MarkdownRendering

      Inject via initializers instead of using .shared singletons.

recommendations_summary:
  immediate_action_required:
    - CRIT-001: Race condition will crash app
    - CRIT-002: Memory leak makes app unusable

  high_priority_fixes:
    - HIGH-001: File I/O on main thread (isPageBundle)
    - HIGH-002: Blocking disk I/O (FileSystemService)
    - HIGH-003: Blocking CPU work (FrontmatterParser)
    - HIGH-004: Create EditorViewModel
    - HIGH-006: Add keyboard shortcuts
    - HIGH-007: Add undo/redo menu

  architecture_improvements:
    - Create EditorViewModel (HIGH-004)
    - Move service calls to ViewModels (HIGH-005)
    - Split large view files (MED-006)
    - Add protocol abstractions (REFACTOR-004)

  code_quality_improvements:
    - Eliminate frontmatter parsing duplication (MED-001)
    - Extract duplicate openPageBundle logic (MED-002)
    - Improve error handling with Result types (MED-007)
    - Add documentation (LOW-007)

  ux_polish:
    - Add keyboard shortcuts ⌘B/⌘I (HIGH-006)
    - Add undo/redo menu (HIGH-007)
    - Add accessibility labels (MED-008)
    - Add escape key handler (LOW-006)

estimated_effort:
  critical_fixes: 8-10 hours
  high_priority_fixes: 16-20 hours
  medium_priority_fixes: 8-12 hours
  low_priority_fixes: 4-6 hours
  refactoring: 12-16 hours
  total: 48-64 hours (1-1.5 weeks)

next_steps:
  phase_1_critical:
    - Fix race condition in AutoSaveService
    - Fix memory leak in search filter
    - Move file I/O off main thread

  phase_2_architecture:
    - Create EditorViewModel
    - Remove @MainActor from FileSystemService
    - Remove @MainActor from FrontmatterParser

  phase_3_quality:
    - Eliminate code duplication
    - Improve error handling
    - Split large files

  phase_4_polish:
    - Add keyboard shortcuts
    - Add accessibility features
    - Add documentation
